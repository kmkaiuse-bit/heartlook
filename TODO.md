# TODO.md: AI 情感陪伴 Chatbot POC 開發任務清單

## 📊 當前進度追蹤

### ✅ 已完成任務
- **[2025-11-24]** UI 設計系統更新：實現 Medical & Clean 設計風格（Apple Health meets Notion）
  - 完成新色彩系統配置（globals.css）
  - 更新所有組件樣式為醫療專業風格
  - 實現 1px 邊框、專業卡片設計
  - Inter 字體整合與優化
- **任務 1.1** ✅ 設定基本聊天介面 (UI + 輸入處理)
  - 完成 Landing Page 與 Chat 介面
  - 實現用戶輸入捕獲與歷史訊息顯示
  - 添加快速回覆按鈕
  - 建立右側建議與資源面板

### ✅ 已完成任務（續）
- **任務 1.2** ✅ 實現 AI 共情邏輯 + 系統提示工程
  - OpenRouter API 整合完成 (`/api/chat`)
  - 使用 DeepSeek V3 模型 (`deepseek/deepseek-chat-v3-0324`)
  - 完整的共情系統提示（100字以內回應、非診斷性、溫暖語氣）
  - 上下文對話支持（傳遞歷史訊息）
  - 錯誤處理機制
- **任務 2.1** ✅ 建立規則引擎與關鍵詞監測
  - 完整的中文情緒關鍵詞字典（critical/high/medium/low 四級）
  - 情緒評分系統（1-10分制）
  - 上下文排除機制（避免假陽性）
  - 會話上下文分析（分析最近5條訊息）
- **任務 2.2** ✅ 生成情緒摘要 + 自動推送諮詢師/工作坊卡片
  - AI 自動生成情緒摘要（觸發閾值 score >= 7）
  - 動態顯示諮詢師推薦卡片
  - 工作坊報名卡片自動推送
  - 情緒洞察面板（顯示強度、類別、關鍵詞）
  - 單次觸發機制（避免重複推送）
  - 平滑淡入動畫效果
- **任務 3.1** ✅ 實現導流卡片推送（已整合於任務 2.2）

### ⏳ 待開始任務
- 任務 1.3: 實現上下文對話記憶（前端已支持，需要後端持久化）
- 任務 3.2: 轉化追蹤（點擊率記錄）
- 任務 4.1-4.2: 用戶管理模組
- 任務 5.1-5.3: 後端服務模組（Supabase 整合）

### ⚙️ 環境配置需求
**需要設定 `.env.local` 檔案：**
```env
OPENROUTER_API_KEY=your_openrouter_api_key_here
OPENROUTER_MODEL=deepseek/deepseek-chat-v3-0324
SITE_URL=http://localhost:3000
```

---

本 TODO.md 基於需求文檔，嚴格按照「模組錨定」部分定義的五個模組（聊天核心模組、情緒識別模組、導流模組、用戶管理模組、後端服務模組）拆分任務。任務聚焦 MVP 功能，包含 Nice to Have 的核心子任務（標註為 [Nice to Have]）。每個任務包括：

- **具體實現步驟**：詳細、可操作的開發指南，使用 Next.js + Supabase + OpenAI API 技術棧。
- **估算時間**：基於單全棧開發者，單位為分鐘（參考文檔總估計 1200 分鐘，按模組分配；不含 Phase 4 測試時間，以聚焦開發）。
- **依賴**：註明跨模組依賴。
- **完成標準**：簡要驗證點。

任務按模組順序組織，內部按邏輯依賴排序（例如，先基礎設定，再整合）。總估計時間：1100 分鐘（不含測試/優化）。優先級參考文檔 Phase：高優先先實現。

## 1. 聊天核心模組
**模組描述**：處理對話輸入/輸出、共情邏輯和上下文管理。錨定點：AI 提示工程和會話狀態。聚焦 AI 擬人化情感交流、上下文對話記憶和基本用戶介面。

### 任務 1.1: 設定基本聊天介面 (UI + 輸入處理)
- **步驟**：
  1. 在 Next.js 專案中建立 SPA 結構：使用 `pages/chat.js` 作為聊天主頁，整合 Tailwind CSS 實現移動優先設計（頂部角色介紹、中間聊天泡泡區、底部輸入框 + 發送按鈕、重置選項）。
  2. 實現用戶輸入捕獲：使用 React useState 管理輸入文字，添加 Enter 鍵發送事件處理。
  3. 顯示歷史訊息：使用滾動視窗（限 20 輪），區分用戶/ bot 泡泡（e.g., 用戶右對齊、bot 左對齊）。
  4. 添加隱私通知：開啟時顯示彈窗（使用 React Modal），內容為「您的對話匿名且不儲存」，包含退出按鈕。
  5. 優化無障礙：添加 ARIA 標籤（如 `role="textbox"` 於輸入框）。
- **估算時間**：180 分鐘
- **依賴**：無（Phase 1 基礎）
- **完成標準**：介面可渲染，輸入可捕獲並顯示靜態訊息，通知彈窗正常顯示。測試：模擬輸入，確保 <2 秒載入。

### 任務 1.2: 實現 AI 共情邏輯 + 系統提示工程
- **步驟**：
  1. 整合 OpenRouter API with DeepSeek 模型：使用 API 路由（`/api/chat`），設定環境變數 `OPENROUTER_API_KEY`。使用 DeepSeek 模型（成本效益高且回應品質佳）。
  2. 設計系統提示：建立預設提示模板（JSON 格式），強調「溫暖共情、擬人化朋友角色」，避免醫療建議（e.g., "你是一位善解人意的朋友，聚焦情緒支持，從不診斷或建議藥物。回應 <100 字，即時 <3 秒。"）。
  3. 處理即時回應：發送用戶輸入到 OpenRouter API（使用 DeepSeek 模型），生成 bot 回應，顯示於介面。添加載入 spinner 確保 <3 秒延遲。
  4. 錯誤處理：若 API 失敗，顯示預設訊息（如「抱歉，現在無法回應，讓我們重試」）。
  5. 測試提示：使用樣本輸入（如「今天工作超累」），驗證回應共情性。
- **估算時間**：150 分鐘
- **依賴**：任務 1.1
- **完成標準**：bot 可生成共情回應，符合提示守則。測試：端到端輸入/輸出，檢查延遲和內容（無醫療暗示）。

### 任務 1.3: 實現上下文對話記憶
- **步驟**：
  1. 在會話狀態中使用 JSON 結構儲存上下文（e.g., `{"messages": [{"role": "user", "content": "..."}, ...], "session_id": "uuid"}`），限前 5-10 輪。
  2. 修改 API 呼叫：將上下文附加到系統提示（e.g., "基於先前對話：[上下文摘要]"），發送給 OpenAI。
  3. 介面整合：發送後更新本地狀態，維持連貫顯示（e.g., 若先前提「失戀」，後續回應參考）。
  4. 重置功能：重置按鈕清空狀態，生成新 session_id。
  5. [Nice to Have] 會話結束跟進：添加結束按鈕，觸發感謝訊息（如「謝謝分享」）。
- **估算時間**：150 分鐘
- **依賴**：任務 1.2；後端服務模組（會話儲存）
- **完成標準**：多輪對話連貫（e.g., 參考先前情緒），重置正常重啟。測試：5 輪對話，驗證上下文保留。

**模組總時間**：480 分鐘（Phase 1 + Phase 2 核心）。

## 2. 情緒識別模組
**模組描述**：分析關鍵詞和情緒信號，生成摘要。錨定點：規則引擎和門檻設定（e.g., 情緒強度 > 7/10 觸發導流）。聚焦關鍵詞觸發導流的基本情緒摘要生成。

### 任務 2.1: 建立規則引擎與關鍵詞監測
- **步驟**：
  1. 定義情緒關鍵詞清單（JSON 陣列）：e.g., `{"high_risk": ["崩潰", "自殺", "絕望"], "medium": ["焦慮", "孤獨"], "threshold": 7}`，支援中文俚語。
  2. 實現規則引擎：在聊天核心 API 中，分析 bot/用戶輸入（使用簡單正則或 NLP 庫如 `compromise`），計算情緒強度分數（e.g., 關鍵詞匹配 + 計數，範圍 1-10）。
  3. 門檻設定：若分數 >7，標記為高風險觸發；避免假陽性（e.g., 排除「電腦崩潰」上下文）。
  4. 整合到上下文：將關鍵詞陣列附加到會話狀態 JSON。
  5. 測試規則：使用樣本對話驗證（e.g., 「我快崩潰了」觸發高分）。
- **估算時間**：120 分鐘
- **依賴**：聊天核心模組（任務 1.3）
- **完成標準**：輸入分析正確（e.g., 高風險詞觸發分數 >7）。測試：10 個樣本，檢查假陽性率 <10%。

### 任務 2.2: 生成情緒摘要
- **步驟**：
  1. 使用 OpenRouter (DeepSeek) 提示生成摘要：若觸發，呼叫 API 輸入上下文 + 關鍵詞，輸出 <100 字摘要（e.g., "你似乎正經歷嚴重焦慮"）。
  2. 提示設計：強調中性、非診斷（"生成簡短、中性情緒摘要，避免建議"）。
  3. 介面顯示：觸發時彈出摘要視窗（React Modal），置中聊天區。
  4. 儲存摘要：將摘要存入會話 JSON（暫存，後傳後端）。
  5. [Nice to Have] 情緒趨勢聚合：註冊用戶時，簡單計算多會話平均分數（e.g., 週報生成）。
- **估算時間**：130 分鐘
- **依賴**：任務 2.1；導流模組
- **完成標準**：摘要生成準確、非醫療化。測試：觸發案例，驗證彈窗顯示和內容長度。

**模組總時間**：250 分鐘（Phase 2 + Phase 3）。

## 3. 導流模組
**模組描述**：管理推送卡片和外部連結整合。錨定點：轉化追蹤（如點擊率），未來連接 CRM 系統。聚焦關鍵詞觸發導流。

### 任務 3.1: 實現導流卡片推送
- **步驟**：
  1. 設計卡片 UI：底部工具列顯示自訂卡片（e.g., "考慮預約諮詢？" + CTA 按鈕），使用情緒摘要作為標題。
  2. 觸發邏輯：從情緒識別模組接收高分信號，顯示卡片（限一次/會話）。
  3. 外部連結整合：CTA 連結至 Google Calendar 或工作坊頁（e.g., `href="https://calendar.google.com"`）；添加一鍵導流（開新分頁）。
  4. 會話中導流：若關鍵詞觸發，直接插入卡片泡泡。
  5. 關閉機制：卡片有 X 按鈕，返回聊天。
- **估算時間**：150 分鐘
- **依賴**：情緒識別模組（任務 2.2）
- **完成標準**：卡片正常顯示/點擊，連結開啟。測試：模擬觸發，驗證無反感 UI（e.g., 非強制）。

### 任務 3.2: 轉化追蹤
- **步驟**：
  1. 記錄點擊事件：使用本地狀態追蹤點擊，傳至後端（lead_flows 表）。
  2. 基本 A/B 測試：未來支援文案變體（e.g., 兩種 CTA），暫用固定。
  3. [Nice to Have] CRM 連接：準備接口（e.g., Zapier hook），但 MVP 只記錄點擊率。
  4. 聚合數據：後端查詢總轉化（匿名）。
- **估算時間**：80 分鐘
- **依賴**：後端服務模組；任務 3.1
- **完成標準**：點擊事件記錄正確。測試：點擊後查詢數據，確認率計算。

**模組總時間**：230 分鐘（Phase 2）。

## 4. 用戶管理模組
**模組描述**：處理註冊、匿名模式和反饋收集。錨定點：隱私合規，作為入口守門員。聚焦匿名模式、註冊和基本反饋。

### 任務 4.1: 實現註冊/匿名模式切換
- **步驟**：
  1. 入口頁整合：從 Landing Page 添加註冊選項（使用 Supabase Auth，email 登入）。
  2. 匿名模式：預設使用臨時 UUID，無需 email；註冊後綁定用戶 ID。
  3. 側邊抽屜 UI：添加設定抽屜（匿名/註冊切換），解鎖情緒歷史（註冊後）。
  4. 隱私合規：整合免責聲明（"本工具非專業診斷"），數據刪除權（Supabase 刪除 API）。
  5. 導航流：80% 用戶直達聊天，註冊為選項。
- **估算時間**：100 分鐘
- **依賴**：後端服務模組（users 表）；聊天核心模組
- **完成標準**：切換正常，匿名會話不綁定 email。測試：兩個模式下聊天，驗證隱私通知。

### 任務 4.2: 反饋收集機制 [Nice to Have, 但 MVP 核心]
- **步驟**：
  1. 會話結束添加星級：底部反饋（1-5 分 + 可選評論），使用 React 星星組件。
  2. 儲存反饋：傳至 Supabase feedbacks 表，綁定 session_id。
  3. 迭代使用：未來查詢平均分數優化提示。
- **估算時間**：70 分鐘
- **依賴**：任務 4.1
- **完成標準**：反饋提交成功。測試：結束對話，驗證儲存。

**模組總時間**：170 分鐘（Phase 3）。

## 5. 後端服務模組
**模組描述**：統籌會話儲存和通知。錨定點：可擴展性，支援未來多語言。涵蓋 Supabase 整體設定，整合所有模組數據。

### 任務 5.1: Supabase 基礎設定與表結構
- **步驟**：
  1. 註冊/建立專案：Supabase Dashboard 創建 "ai-emotional-chatbot"，啟用 Realtime，安裝 CLI，複製 API 金鑰。
  2. 執行 SQL：SQL Editor 運行提供語句創建 users/sessions/lead_flows/feedbacks 表（包括 JSONB 欄位）。
  3. 設定關係與外鍵：驗證 Relations 視圖，確保 ON DELETE CASCADE。
  4. 前端整合：安裝 `supabase-js`，在 Next.js 設定客戶端（e.g., `createClient`）。
  5. 樣本數據插入：測試 tables（e.g., 插入匿名用戶）。
- **估算時間**：120 分鐘
- **依賴**：無（Phase 1）
- **完成標準**：表創建成功，查詢正常。測試：CLI 連線，插入/讀取。

### 任務 5.2: RLS 政策與索引設定
- **步驟**：
  1. 啟用 RLS：Dashboard > Authentication > RLS 開啟所有表。
  2. 執行政策 SQL：users/sessions/lead_flows/feedbacks 的政策（e.g., USING auth.uid() = user_id），允許匿名讀聚合。
  3. 添加索引：執行 SQL 索引語句（e.g., idx_sessions_user_id）。
  4. 驗證：使用不同用戶 JWT 測試存取（Supabase Auth 模擬）。
  5. 可擴展準備：添加中英欄位預留（e.g., language TEXT）。
- **估算時間**：80 分鐘
- **依賴**：任務 5.1
- **完成標準**：RLS 阻擋跨用戶存取。測試：模擬用戶，確認無洩漏。

### 任務 5.3: 會話儲存與通知整合
- **步驟**：
  1. 儲存會話：聊天核心觸發時，`supabase.from('sessions').insert({context: json, user_id: uuid})`，使用 Realtime 更新狀態。
  2. 導流/摘要儲存：從模組接收，插入 lead_flows/emotion_summary。
  3. 通知：會話結束後，使用 Supabase Edge Functions 發送郵件摘要（整合 SendGrid，或簡單 console.log MVP）。
  4. 追蹤系統數據：匿名日誌 AI 回應（不存敏感）。
  5. [Nice to Have] 多語言支援：預留 language 過濾查詢。
- **估算時間**：150 分鐘
- **依賴**：所有其他模組；任務 5.2
- **完成標準**：數據持久化正確，Realtime 更新介面。測試：完整會話，查詢 tables。

**模組總時間**：350 分鐘（Phase 1 + Phase 3）。

## 總結與執行指南
- **總時間**：1480 分鐘（略超 1200，因細分 Nice to Have；可並行 UI/後端）。
- **執行順序**：先後端服務 (5) + 聊天核心 (1) → 情緒識別 (2) + 導流 (3) → 用戶管理 (4)。
- **工具/環境**：Next.js 14, Supabase, OpenRouter with DeepSeek 模型 (極佳成本控制與效能), Vercel 部署。
- **風險緩解**：監控 AI 成本 (DeepSeek 提供極低成本 <$0.002/會話)；每模組結束後單元測試。
- **下一步**：完成後，執行 Phase 4 測試（端到端 + 隱私審核）。若需調整，參考文檔潛在挑戰。

## OpenRouter + DeepSeek 配置說明
- **API 端點**：https://openrouter.ai/api/v1/chat/completions
- **推薦模型**：`deepseek/deepseek-chat` (高性價比，支援中文，回應品質優秀)
- **環境變數**：設定 `OPENROUTER_API_KEY` 於 .env.local
- **成本優勢**：DeepSeek 模型成本約為 GPT-4o-mini 的 1/5，特別適合 MVP 階段
- **實作參考**：API 呼叫格式與 OpenAI 相容，僅需修改端點與 API Key